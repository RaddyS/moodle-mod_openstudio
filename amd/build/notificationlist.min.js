define(["jquery","core/ajax","core/modal","core/templates","theme_bootstrapbase/boostrap"],function(a,b,c,d){var e={STOPBUTTONS:".openstudio-notification-stopbutton",NOTIFICATIONBUTTON:".openstudio-nav-primary .dropdown.notifications",UNREAD:".openstudio-notifications-list .openstudio-notification-unread"},f={cmid:null,followflag:null},g={modal:null,init:function(b,c){f.cmid=b,f.followflag=c,a(e.STOPBUTTONS).on("click",g.stopNotifications),a('[data-toggle="tooltip"]').tooltip(),a(e.UNREAD).length>0&&a(e.NOTIFICATIONBUTTON).on("click",g.readNotifications),d.render("mod_openstudio/notification_modal",{name:""}),d.render("core/modal_backdrop")},reShowList:function(){window.setTimeout(function(){a(e.NOTIFICATIONBUTTON).addClass("open")},0)},stopNotifications:function(b){b.preventDefault(),g.reShowList();var e,f=a(b.target).closest(".openstudio-notification"),h=a(b.currentTarget).data("contentid"),i=a(b.currentTarget).data("commentid");e=i?"mod_openstudio/commentnotification_modal":"mod_openstudio/notification_modal",d.render(e,{name:f.find(".openstudio-notification-message a").text(),contentid:h,commentid:i}).done(function(a){g.modal=new c(a),g.modal.body.find("button").on("click",g.handleModalButton),g.modal.show()})},handleModalButton:function(c){g.reShowList();var d=a(c.target);if("yes"===d.data("action")){M.util.js_pending("openstudioStopNotifications");var e,h=d.data("commentid"),i={cmid:f.cmid,cid:d.data("contentid"),fid:f.followflag};h?(i.commentid=h,e="mod_openstudio_external_flag_comment"):(i.mode="off",e="mod_openstudio_external_flag_content");var j=b.call([{methodname:e,args:i}]);j[0].done(function(){a('.openstudio-notifications-list button[data-contentid="'+d.data("contentid")+'"]').remove(),M.util.js_complete("openstudioStopNotifications")}).fail(function(){window.console.error("Could not un-follow content"),M.util.js_complete("openstudioStopNotifications")})}g.modal.hide()},readNotifications:function(c){c.preventDefault();var d=a(e.UNREAD).map(function(){return a(this).data("id")}).get(),h=b.call([{methodname:"mod_openstudio_external_read_notifications",args:{cmid:f.cmid,ids:d}}]);h[0].done(function(){a(".openstudio-navigation-notification-text").hide(),a(e.NOTIFICATIONBUTTON).off("click",g.readNotifications)}).fail(function(a){window.console.error("Could not mark notifications read. "+a.message)})}};return g});