define(["jquery","core/ajax","core/str","core/modal","core/templates","core/config","require"],function(e,t,o,n,a,i,d){var c;return c={dialogue:null,delete_item:null,mconfig:null,init:function(t){e.fx.off=!0,c.mconfig=t,Y.use("moodle-core-notification-dialogue",function(){d(["mod_openstudio/osdialogue"],function(e){c.archiveDialogue=c.createArchiveDialogue(e),c.deleteContentDialogue=c.createDeleteContentDialogue(e)})}),c.createMaximizeModal(),e("#openstudio_content_view_maximize").on("click",c.toogleContentModal),e("body").delegate("#openstudio_content_view_minimize","click",c.toogleContentModal),e("body").delegate(".openstudio-modal-content-close","click",c.toogleContentModal);var o=e("#openstudio_content_view_map_canvas");o.length&&c.showGoogleMap(o),e("#id_archivebutton").on("click",function(e){e.preventDefault(),c.archiveDialogue.show()}),e(".openstudio-delete-content-version").on("click",function(t){t.preventDefault(),c.delete_item=e(this),c.deleteContentDialogue.show()}),e(".openstudio-content-view-flag-icon").bind("click",function(){c.doFlagContent(e(this))}),e(".openstudio-request-feedback-button").bind("click",function(){c.doFlagContent(e(this))})},createMaximizeModal:function(){a.render("mod_openstudio/content_modal",{title:e(".openstudio-content-view-title").text(),body:e(".openstudio-content-view-file").html(),date:e(".openstudio-content-view-date").html(),isiframecontent:e(".openstudio-content-view-file").find("iframe").length>0}).done(function(e){c.modal=new n(e),c.modal.setLarge()})},toogleContentModal:function(){c.modal&&(c.modal.isVisible()?c.modal.hide():c.modal.show(),e("body").toggleClass("openstudio-lockscroll"))},showGoogleMap:function(e){var t=e.attr("data-gpslat"),o=e.attr("data-gpslng");if(t&&o){var n={lat:parseFloat(t),lng:parseFloat(o)};map=new google.maps.Map(document.getElementById("openstudio_content_view_map_canvas"),{center:n,zoom:14}),new google.maps.Marker({position:n,map:map})}},doFlagContent:function(o){var n=t.call([{methodname:"mod_openstudio_external_flag_content",args:{cmid:o.attr("data-cmid"),cid:o.attr("data-cid"),fid:o.attr("data-fid"),mode:o.attr("data-mode")}}]);n[0].done(function(t){if(t.success){var o=e("#content_view_icon_"+t.fid);o.attr("data-mode",t.mode),t.iscontentflagrequestfeedback?(o.html(t.flagtext),e("#openstudio_item_request_feedback").removeClass(t.flagremoveclass).addClass(t.flagaddclass)):(o.html(t.flagtext),o.removeClass(t.flagremoveclass).addClass(t.flagaddclass))}}).fail(function(e){window.console.error("Error saving social flag "+e.message)})},setHeader:function(e,t){o.get_string(t,"mod_openstudio").done(function(t){e.set("headerContent",'<span class="openstudio-dialogue-common-header">'+t+"</span>")})},setBody:function(e,t){o.get_string(t,"mod_openstudio").done(function(t){e.set("bodyContent","<span>"+t+"</span>")})},createArchiveDialogue:function(t){var n=new t({closeButton:!0,visible:!1,centered:!0,responsive:!0,responsiveWidth:767,modal:!0,focusOnPreviousTargetAfterHide:!0,width:521});c.setHeader(n,"archivedialogheader"),c.setBody(n,"modulejsdialogcontentarchiveconfirm");var a={name:"archive",classNames:"openstudio-archive-yes-btn",events:{click:function(){c.redirectPostRequest({url:e("#contentversionlink").val(),data:{archiveversion:1}})}}},i={name:"cancel",classNames:"openstudio-archive-no-btn",action:"hide"};return o.get_strings([{key:"contentactionarchivepost",component:"mod_openstudio"},{key:"modulejsdialogcancel",component:"mod_openstudio"}]).done(function(e){a.label=e[0],i.label=e[1],n.addButton(a,["footer"]),n.addButton(i,["footer"])}),n},createDeleteContentDialogue:function(n){var a=new n({closeButton:!0,visible:!1,centered:!0,responsive:!0,responsiveWidth:767,modal:!0,focusOnPreviousTargetAfterHide:!0,width:521});c.setHeader(a,"deletearchiveversionheader"),c.setBody(a,"deletearchiveversionheaderconfirm");var i={name:"delete",classNames:"openstudio-delete-btn",events:{click:function(){var o=c.delete_item,n=t.call([{methodname:"mod_openstudio_external_delete_version",args:{cmid:o.attr("data-cmid"),cid:o.attr("data-cid"),cvid:o.attr("data-cvid")}}]);n[0].done(function(t){e(".openstudio-cancel-btn").trigger("click"),e("#contentcurrenteversionurl").length>0?window.location.href=e("#contentcurrenteversionurl").val():e("#content_version_id_"+o.attr("data-cvid")).remove()}).fail(function(e){window.console.error("Error delete content version"+e.message)})}}},d={name:"cancel",classNames:"openstudio-cancel-btn",action:"hide"};return o.get_strings([{key:"modulejsdialogdelete",component:"mod_openstudio"},{key:"modulejsdialogcancel",component:"mod_openstudio"}]).done(function(e){i.label=e[0],d.label=e[1],a.addButton(i,["footer"]),a.addButton(d,["footer"])}),a},redirectPostRequest:function(t){var o=e("<form></form>");o.attr({method:"POST",action:t.url,style:"display: none;"}),e.each(t.data,function(t,n){var a=e("<input/>");a.attr("type","hidden"),a.attr("name",t),a.attr("value",n),o.append(a)}),e(o).appendTo("body").submit()}}});