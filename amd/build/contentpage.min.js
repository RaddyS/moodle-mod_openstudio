define(["jquery","core/ajax","core/str","core/modal","core/modal_events","core/templates","core/config","require"],function(a,b,c,d,e,f,g,h){var i;return i={dialogue:null,delete_item:null,mconfig:null,init:function(b){a.fx.off=!0,i.mconfig=b,Y.use("moodle-core-notification-dialogue",function(){h(["mod_openstudio/osdialogue"],function(a){i.archiveDialogue=i.createArchiveDialogue(a),i.deleteContentDialogue=i.createDeleteContentDialogue(a)})}),i.createMaximizeModal(),a("#openstudio_content_view_maximize").on("click",i.toogleContentModal),a("body").delegate("#openstudio_content_view_minimize","click",i.toogleContentModal),a("body").delegate(".openstudio-modal-content-close","click",i.toogleContentModal);var c=a("#openstudio_content_view_map_canvas");c.length&&i.showGoogleMap(c),a("#id_archivebutton").on("click",function(a){a.preventDefault(),i.archiveDialogue.show()}),a(".openstudio-delete-content-version").on("click",function(b){b.preventDefault(),i.delete_item=a(this),i.deleteContentDialogue.show()}),a(".openstudio-content-view-flag-icon").bind("click",function(){i.doFlagContent(a(this))}),a(".openstudio-request-feedback-button").bind("click",function(){i.doFlagContent(a(this))})},createMaximizeModal:function(){f.render("mod_openstudio/content_modal",{title:a(".openstudio-content-view-title").text(),body:a(".openstudio-content-view-file").html(),date:a(".openstudio-content-view-date").html(),isiframecontent:a(".openstudio-content-view-file").find("iframe").length>0}).done(function(a){i.modal=new d(a),i.modal.setLarge()})},toogleContentModal:function(){i.modal&&(i.modal.isVisible()?i.modal.hide():(i.modal.show(),i.modal.getRoot().on(e.shown,function(){a(".openstudio-modal-content-close").get(0).focus(),a(".openstudio-modal-content-close, #openstudio_content_view_minimize").keydown(function(b){if(13==b.keyCode)return i.modal.hide(),a("#openstudio_content_view_maximize").focus(),!1}),a("#openstudio_content_view_minimize").keydown(function(b){b.preventDefault(),9==b.keyCode&&a(".openstudio-modal-content-close").get(0).focus()})})),a("body").toggleClass("openstudio-lockscroll"))},showGoogleMap:function(a){var b=a.attr("data-gpslat"),c=a.attr("data-gpslng");if(b&&c){var d={lat:parseFloat(b),lng:parseFloat(c)},e=new google.maps.Map(document.getElementById("openstudio_content_view_map_canvas"),{center:d,zoom:14});new google.maps.Marker({position:d,map:e})}},doFlagContent:function(c){var d=b.call([{methodname:"mod_openstudio_external_flag_content",args:{cmid:c.attr("data-cmid"),cid:c.attr("data-cid"),fid:c.attr("data-fid"),mode:c.attr("data-mode")}}]);d[0].done(function(b){if(b.success){var c=a("#content_view_icon_"+b.fid);c.attr("data-mode",b.mode),b.iscontentflagrequestfeedback?(c.html(b.flagtext),a("#openstudio_item_request_feedback").removeClass(b.flagremoveclass).addClass(b.flagaddclass)):(c.find(".openstudio-content-view-icon-text").text(b.flagtext),c.toggleClass("openstudio-content-view-icon-active","off"==b.mode),c.attr("title",b.accessiblemessage))}}).fail(function(a){window.console.error("Error saving social flag "+a.message)})},setHeader:function(a,b){c.get_string(b,"mod_openstudio").done(function(b){a.set("headerContent",'<span class="openstudio-dialogue-common-header">'+b+"</span>")})},setBody:function(a,b){c.get_string(b,"mod_openstudio").done(function(b){a.set("bodyContent","<span>"+b+"</span>")})},createArchiveDialogue:function(b){var d=new b({closeButton:!0,visible:!1,centered:!0,responsive:!0,responsiveWidth:767,modal:!0,focusOnPreviousTargetAfterHide:!0,width:521});i.setHeader(d,"archivedialogheader"),i.setBody(d,"modulejsdialogcontentarchiveconfirm");var e={name:"archive",classNames:"openstudio-archive-yes-btn",events:{click:function(){i.redirectPostRequest({url:a("#contentversionlink").val(),data:{archiveversion:1}})}}},f={name:"cancel",classNames:"openstudio-archive-no-btn",action:"hide"};return c.get_strings([{key:"contentactionarchivepost",component:"mod_openstudio"},{key:"modulejsdialogcancel",component:"mod_openstudio"}]).done(function(a){e.label=a[0],f.label=a[1],d.addButton(e,["footer"]),d.addButton(f,["footer"])}),d},createDeleteContentDialogue:function(d){var e=new d({closeButton:!0,visible:!1,centered:!0,responsive:!0,responsiveWidth:767,modal:!0,focusOnPreviousTargetAfterHide:!0,width:521});i.setHeader(e,"deletearchiveversionheader"),i.setBody(e,"deletearchiveversionheaderconfirm");var f={name:"delete",classNames:"openstudio-delete-btn",events:{click:function(){var c=i.delete_item,d=b.call([{methodname:"mod_openstudio_external_delete_version",args:{cmid:c.attr("data-cmid"),cid:c.attr("data-cid"),cvid:c.attr("data-cvid")}}]);d[0].done(function(){a(".openstudio-cancel-btn").trigger("click"),a("#contentcurrenteversionurl").length>0?window.location.href=a("#contentcurrenteversionurl").val():(a("#content_version_id_"+c.attr("data-cvid")).remove(),0==a(".openstudio-content-view-version-detail").length&&a("#openstudio_content_view_post_archive_panel").remove())}).fail(function(a){window.console.error("Error delete content version"+a.message)})}}},g={name:"cancel",classNames:"openstudio-cancel-btn",action:"hide"};return c.get_strings([{key:"modulejsdialogdelete",component:"mod_openstudio"},{key:"modulejsdialogcancel",component:"mod_openstudio"}]).done(function(a){f.label=a[0],g.label=a[1],e.addButton(f,["footer"]),e.addButton(g,["footer"])}),e},redirectPostRequest:function(b){var c=a("<form></form>");c.attr({method:"POST",action:b.url,style:"display: none;"}),a.each(b.data,function(b,d){var e=a("<input/>");e.attr("type","hidden"),e.attr("name",b),e.attr("value",d),c.append(e)}),a(c).appendTo("body").submit()}}});