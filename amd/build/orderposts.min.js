define(["jquery","core/ajax","core/str","core/templates","require"],function(e,o,t,r,n){var s;return s={mconfig:null,CSS:{ORDER_POSTS_BUTTON:"#id_orderpost",MOVE_UP_BUTTON:".openstudio-orderpost-item-moveup-button",MOVE_DOWN_BUTTON:".openstudio-orderpost-item-movedown-button",SAVE_ORDER_BUTTON:".openstudio-orderpost-save-button",ORDER_NUMBER_INPUT:".openstudio-orderpost-item-order-number-input",ITEM_CONTAINER:".openstudio-orderpost-item",ITEM_ORDER:".openstudio-orderpost-item-order",ORDER_POSTS_DIALOGUE_CONTAINER:".openstudio-orderposts-dialogue"},init:function(o){s.mconfig=o,Y.use("moodle-core-notification-dialogue",function(){n(["mod_openstudio/osdialogue"],function(e){s.dialogue=s.createOrderPostsDialogue(e)})}),e(s.CSS.ORDER_POSTS_BUTTON).on("click",function(){if(s.dialogue){e(".openstudio-folder-posts-dialogue .openstudio-orderpost").remove(),s.setBody(s.dialogue),s.dialogue.show();var o=s.getListOrderPost(),t=[];e.each(o,function(e,o){t[e]=o[0]}),s.mconfig.listorder=t.join(","),setTimeout(function(){s.resize()},200)}}),e("body").delegate(s.CSS.SAVE_ORDER_BUTTON,"click",s.saveOrder).delegate(s.CSS.MOVE_UP_BUTTON,"click",s.moveUp).delegate(s.CSS.MOVE_DOWN_BUTTON,"click",s.moveDown).delegate(s.CSS.ORDER_NUMBER_INPUT,"keyup",s.moveTo),e(window).resize(s.resize.bind(s))},createOrderPostsDialogue:function(e){function o(){t.get_string("folderorderpost","mod_openstudio").done(function(e){r.set("headerContent","<span>"+e+"</span>")})}var r=new e({closeButton:!0,visible:!1,centered:!0,modal:!0,responsive:!0,width:640,responsiveWidth:767,focusOnPreviousTargetAfterHide:!0,extraClasses:[s.CSS.ORDER_POSTS_DIALOGUE_CONTAINER.replace(".",""),"openstudio-folder-posts-dialogue"]});return o(),s.setBody(r),r},setBody:function(t){M.util.js_pending("openstudioGetOrderPostsFolderContent");var r=o.call([{methodname:"mod_openstudio_external_get_order_posts",args:{cmid:s.mconfig.cmid,folderid:s.mconfig.folderid}}]);r[0].done(function(o){t.set("bodyContent",o.html),s.disableFirstLastButton(),s.disableContentButton(),s.checkReorder(),s.inputPosition(),e(s.CSS.SAVE_ORDER_BUTTON).attr("disabled","disabled")}).always(function(){M.util.js_complete("openstudioGetOrderPostsFolderContent")}).fail(function(e){window.console.error("Log request failed "+e.message)})},moveUp:function(){var o=e(this).closest(s.CSS.ITEM_CONTAINER),t=o.find(s.CSS.ITEM_ORDER).attr("data-order");t=parseInt(t),s.swapItems(t,t-1,o)},moveDown:function(){var o=e(this).closest(s.CSS.ITEM_CONTAINER),t=o.find(s.CSS.ITEM_ORDER).attr("data-order");t=parseInt(t),s.swapItems(t,t+1,o)},moveTo:function(o){if(13==o.which){var r=e(this).val(),n=e(this).closest(s.CSS.ITEM_CONTAINER),i=n.find(s.CSS.ITEM_ORDER).attr("data-order");i=parseInt(i);var d=e(s.CSS.ITEM_CONTAINER).last().find(s.CSS.ITEM_ORDER).attr("data-order");d=parseInt(d);var a=e("div[data-order="+e(this).attr("data-order")+"]").hasClass("openstudio-orderpost-item-canreorder"),u=e("div[data-order="+r+"]").hasClass("openstudio-orderpost-item-canreorder");if(a&&u)return void t.get_string("foldercontentcannotreorder","mod_openstudio").done(function(e){s.showErrorMessage(e)});r>d&&(r=d),1>r&&(r=1),s.swapItems(i,r,n)}},saveOrder:function(){var r=!0;if(e(s.CSS.ORDER_NUMBER_INPUT).each(function(){var o=e(this).val().trim(),n=e(this).closest(s.CSS.ITEM_CONTAINER),i=n.find(s.CSS.ITEM_ORDER).attr("data-order");if(i=parseInt(i),o!=i){var d=e("div[data-order="+e(this).attr("data-order")+"]").hasClass("openstudio-orderpost-item-canreorder"),a=e("div[data-order="+o+"]").hasClass("openstudio-orderpost-item-canreorder");d&&a&&(r=!1,t.get_string("foldercontentcannotreorder","mod_openstudio").done(function(e){s.showErrorMessage(e)})),s.swapItems(i,o,n)}}),r){M.util.js_pending("openstudioOrderPostsFolderContent");var n=s.getListOrderPost(),i={},d="",a="";e.each(n,function(e,o){a=o[0],d=o[1],a!=d&&(i[d-1]=a)}),n="",e.each(i,function(e,o){n+=e+"-"+o+","}),n=n.substr(0,n.length-1);var u=o.call([{methodname:"mod_openstudio_external_order_posts",args:{cmid:s.mconfig.cmid,folderid:s.mconfig.folderid,listorderporst:n}}]);u[0].done(function(){window.location.reload()}).always(function(){M.util.js_complete("openstudioOrderPostsFolderContent")}).fail(function(e){window.console.error("Log request failed "+e.message)})}},swapItems:function(o,t,r){var n=e(s.CSS.ITEM_ORDER+'[data-order="'+t+'"]');n.length>0&&(t>o?n.closest(s.CSS.ITEM_CONTAINER).after(r):n.closest(s.CSS.ITEM_CONTAINER).before(r),e(s.CSS.ITEM_CONTAINER).each(function(o){o+=1;var t=10>o?"0"+o:""+o;e(this).find(s.CSS.ITEM_ORDER).attr("data-order",o).text(t),e(this).find(s.CSS.ORDER_NUMBER_INPUT).attr("value",o)}));var i=s.mconfig.listorder,d=s.getListOrderPost(),a=[];e.each(d,function(e,o){a[e]=o[0]});var u=a.join(",");s.enableSaveOrder(i,u),s.checkReorder(),s.disableFirstLastButton(),s.inputPosition()},resize:function(){s.dialogue&&s.dialogue.get("visible")&&(Y.one("body").get("winWidth")<s.dialogue.get("responsiveWidth")?(s.dialogue.makeResponsive(),e(s.CSS.SAVE_ORDER_BUTTON).removeClass("osep-smallbutton")):(e(s.CSS.SAVE_ORDER_BUTTON).addClass("osep-smallbutton"),Y.one("body").get("winWidth")>=767?s.dialogue.set("width",640):s.dialogue.set("width",500),s.dialogue.centerDialogue()))},getListOrderPost:function(){var o={};e(s.CSS.ITEM_CONTAINER).each(function(){var t=e(this).find(s.CSS.ITEM_ORDER);o[t.attr("data-order")]=t.attr("data-original-order")});var t=[];for(var r in o)t.push([r,o[r]]);return t.sort(function(e,o){return e[1]-o[1]}),t},enableSaveOrder:function(o,t){o!=t?e(s.CSS.SAVE_ORDER_BUTTON).removeAttr("disabled"):e(s.CSS.SAVE_ORDER_BUTTON).attr("disabled","disabled")},inputPosition:function(){e(document).ready(function(){e(s.CSS.ORDER_NUMBER_INPUT).keyup(function(){s.enableSaveOrder(e(this).val().length,0);var o=e(this).val();o&&!e.isNumeric(o)?t.get_string("errormoveslotnumeric","mod_openstudio").done(function(e){s.showErrorMessage(e)}):parseInt(o)<=0?t.get_string("errormoveslotduplicate","mod_openstudio").done(function(e){s.showErrorMessage(e)}):parseInt(o)>s.mconfig.total?t.get_string("errormoveslotoutofrange","mod_openstudio").done(function(e){s.showErrorMessage(e)}):s.showErrorMessage(""),e(this).val(o)})})},disableFirstLastButton:function(){e(s.CSS.MOVE_UP_BUTTON).removeAttr("disabled"),e(s.CSS.MOVE_DOWN_BUTTON).removeAttr("disabled"),e(s.CSS.MOVE_UP_BUTTON+":first").attr("disabled","disabled"),e(s.CSS.MOVE_DOWN_BUTTON+":last").attr("disabled","disabled")},disableContentButton:function(){e(document).ready(function(){e(".openstudio-orderpost-item-book").attr("disabled","disabled"),e(".openstudio-orderpost-item-disabled").click(function(){return t.get_string("foldercontentcannotreorder","mod_openstudio").done(function(e){s.showErrorMessage(e)}),!1})})},checkReorder:function(){e(s.CSS.ITEM_CONTAINER).each(function(){var o="openstudio-orderpost-item-canreorder";if(e(this).find(s.CSS.ITEM_ORDER).hasClass("openstudio-orderpost-item-canreorder")){var t=e(this).next();t.find(s.CSS.ITEM_ORDER).hasClass(o)?s.disableContentButton():s.showErrorMessage("")}})},showErrorMessage:function(o){e(".openstudio-message-error").text(o)}}});