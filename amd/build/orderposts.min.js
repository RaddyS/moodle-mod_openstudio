define(["jquery","core/ajax","core/str","core/templates","require"],function(a,b,c,d,e){var f;return f={mconfig:null,CSS:{ORDER_POSTS_BUTTON:"#id_orderpost",MOVE_UP_BUTTON:".openstudio-orderpost-item-moveup-button",MOVE_DOWN_BUTTON:".openstudio-orderpost-item-movedown-button",SAVE_ORDER_BUTTON:".openstudio-orderpost-save-button",ORDER_NUMBER_INPUT:".openstudio-orderpost-item-order-number-input",ITEM_CONTAINER:".openstudio-orderpost-item",ITEM_ORDER:".openstudio-orderpost-item-order",ORDER_POSTS_DIALOGUE_CONTAINER:".openstudio-orderposts-dialogue"},init:function(b){f.mconfig=b,Y.use("moodle-core-notification-dialogue",function(){e(["mod_openstudio/osdialogue"],function(a){f.dialogue=f.createOrderPostsDialogue(a)})}),a(f.CSS.ORDER_POSTS_BUTTON).on("click",function(){if(f.dialogue){a(".openstudio-folder-posts-dialogue .openstudio-orderpost").remove(),f.setBody(f.dialogue),f.dialogue.show();var b=f.getListOrderPost(),c=[];a.each(b,function(a,b){c[a]=b[0]}),f.mconfig.listorder=c.join(","),setTimeout(function(){f.resize()},200)}}),a("body").delegate(f.CSS.SAVE_ORDER_BUTTON,"click",f.saveOrder).delegate(f.CSS.MOVE_UP_BUTTON,"click",f.moveUp).delegate(f.CSS.MOVE_DOWN_BUTTON,"click",f.moveDown).delegate(f.CSS.ORDER_NUMBER_INPUT,"keyup",f.moveTo),a(window).resize(f.resize.bind(f))},createOrderPostsDialogue:function(a){function b(){c.get_string("folderorderpost","mod_openstudio").done(function(a){d.set("headerContent","<span>"+a+"</span>")})}var d=new a({closeButton:!0,visible:!1,centered:!0,modal:!0,responsive:!0,width:640,responsiveWidth:767,focusOnPreviousTargetAfterHide:!0,extraClasses:[f.CSS.ORDER_POSTS_DIALOGUE_CONTAINER.replace(".",""),"openstudio-folder-posts-dialogue"]});return b(),f.setBody(d),d},setBody:function(c){M.util.js_pending("openstudioGetOrderPostsFolderContent");var d=b.call([{methodname:"mod_openstudio_external_get_order_posts",args:{cmid:f.mconfig.cmid,folderid:f.mconfig.folderid}}]);d[0].done(function(b){c.set("bodyContent",b.html),f.disableFirstLastButton(),f.disableContentButton(),f.checkReorder(),f.inputPosition(),a(f.CSS.SAVE_ORDER_BUTTON).attr("disabled","disabled")}).always(function(){M.util.js_complete("openstudioGetOrderPostsFolderContent")}).fail(function(a){window.console.error("Log request failed "+a.message)})},moveUp:function(){var b=a(this).closest(f.CSS.ITEM_CONTAINER),c=b.find(f.CSS.ITEM_ORDER).attr("data-order");c=parseInt(c),f.swapItems(c,c-1,b)},moveDown:function(){var b=a(this).closest(f.CSS.ITEM_CONTAINER),c=b.find(f.CSS.ITEM_ORDER).attr("data-order");c=parseInt(c),f.swapItems(c,c+1,b)},moveTo:function(b){if(13==b.which){var d=a(this).val(),e=a(this).closest(f.CSS.ITEM_CONTAINER),g=e.find(f.CSS.ITEM_ORDER).attr("data-order");g=parseInt(g);var h=a(f.CSS.ITEM_CONTAINER).last().find(f.CSS.ITEM_ORDER).attr("data-order");h=parseInt(h);var i=a("div[data-order="+a(this).attr("data-order")+"]").hasClass("openstudio-orderpost-item-canreorder"),j=a("div[data-order="+d+"]").hasClass("openstudio-orderpost-item-canreorder");if(i&&j)return void c.get_string("foldercontentcannotreorder","mod_openstudio").done(function(a){f.showErrorMessage(a)});d>h&&(d=h),d<1&&(d=1),f.swapItems(g,d,e)}},saveOrder:function(){var d=!0;if(a(f.CSS.ORDER_NUMBER_INPUT).each(function(){var b=a(this).val().trim(),e=a(this).closest(f.CSS.ITEM_CONTAINER),g=e.find(f.CSS.ITEM_ORDER).attr("data-order");if(g=parseInt(g),b!=g){var h=a("div[data-order="+a(this).attr("data-order")+"]").hasClass("openstudio-orderpost-item-canreorder"),i=a("div[data-order="+b+"]").hasClass("openstudio-orderpost-item-canreorder");h&&i&&(d=!1,c.get_string("foldercontentcannotreorder","mod_openstudio").done(function(a){f.showErrorMessage(a)})),f.swapItems(g,b,e)}}),d){M.util.js_pending("openstudioOrderPostsFolderContent");var e=f.getListOrderPost(!0),g={},h="",i="";a.each(e,function(a,b){i=b[0],h=b[1],i!=h&&(g[h-1]=i)}),e="",a.each(g,function(a,b){e+=a+"-"+b+","}),e=e.substr(0,e.length-1);var j=b.call([{methodname:"mod_openstudio_external_order_posts",args:{cmid:f.mconfig.cmid,folderid:f.mconfig.folderid,listorderporst:e}}]);j[0].done(function(){window.location.reload()}).always(function(){M.util.js_complete("openstudioOrderPostsFolderContent")}).fail(function(a){window.console.error("Log request failed "+a.message)})}},swapItems:function(b,d,e){var g=!1,h=a(f.CSS.ITEM_ORDER+'[data-order="'+d+'"]');if(g=f.checkReorderLock(b,d),1==g)return void c.get_string("foldercontentcannotreorder","mod_openstudio").done(function(a){f.showErrorMessage(a)});h.length>0&&(b<d?h.closest(f.CSS.ITEM_CONTAINER).after(e):h.closest(f.CSS.ITEM_CONTAINER).before(e),a(f.CSS.ITEM_CONTAINER).each(function(b){b+=1;var c=b<10?"0"+b:""+b;a(this).find(f.CSS.ITEM_ORDER).attr("data-order",b).text(c),a(this).find(f.CSS.ORDER_NUMBER_INPUT).attr("value",b)}));var i=f.mconfig.listorder,j=f.getListOrderPost(),k=[];a.each(j,function(a,b){k[a]=b[0]});var l=k.join(",");f.enableSaveOrder(i,l),f.checkReorder(),f.disableContentButton(),f.disableFirstLastButton(),f.inputPosition()},resize:function(){f.dialogue&&f.dialogue.get("visible")&&(Y.one("body").get("winWidth")<f.dialogue.get("responsiveWidth")?(f.dialogue.makeResponsive(),a(f.CSS.SAVE_ORDER_BUTTON).removeClass("osep-smallbutton")):(a(f.CSS.SAVE_ORDER_BUTTON).addClass("osep-smallbutton"),Y.one("body").get("winWidth")>=767?f.dialogue.set("width",640):f.dialogue.set("width",500),f.dialogue.centerDialogue()))},getListOrderPost:function(b){var c={};a(f.CSS.ITEM_CONTAINER).each(function(){var d=a(this).find(f.CSS.ITEM_ORDER);b&&d.hasClass("openstudio-orderpost-item-book")||(c[d.attr("data-order")]=d.attr("data-original-order"))});var d=[];for(var e in c)d.push([e,c[e]]);return d.sort(function(a,b){return a[1]-b[1]}),d},enableSaveOrder:function(b,c){b!=c?a(f.CSS.SAVE_ORDER_BUTTON).removeAttr("disabled"):a(f.CSS.SAVE_ORDER_BUTTON).attr("disabled","disabled")},inputPosition:function(){a(document).ready(function(){a(f.CSS.ORDER_NUMBER_INPUT).keyup(function(){f.enableSaveOrder(a(this).val().length,0);var b=a(this).val();b&&!a.isNumeric(b)?c.get_string("errormoveslotnumeric","mod_openstudio").done(function(a){f.showErrorMessage(a)}):parseInt(b)<=0?c.get_string("errormoveslotduplicate","mod_openstudio").done(function(a){f.showErrorMessage(a)}):parseInt(b)>f.mconfig.total?c.get_string("errormoveslotoutofrange","mod_openstudio").done(function(a){f.showErrorMessage(a)}):f.showErrorMessage(""),a(this).val(b)})})},disableFirstLastButton:function(){a(f.CSS.MOVE_UP_BUTTON).removeAttr("disabled"),a(f.CSS.MOVE_DOWN_BUTTON).removeAttr("disabled"),a(f.CSS.MOVE_UP_BUTTON+":first").attr("disabled","disabled"),a(f.CSS.MOVE_DOWN_BUTTON+":last").attr("disabled","disabled")},disableContentButton:function(){a(document).ready(function(){a(".openstudio-orderpost-item-book").attr("disabled","disabled"),a(".openstudio-orderpost-item-disabled").click(function(){return c.get_string("foldercontentcannotreorder","mod_openstudio").done(function(a){f.showErrorMessage(a)}),!1})})},checkReorder:function(){a(f.CSS.ITEM_CONTAINER).each(function(){var b="openstudio-orderpost-item-canreorder";if(a(this).find(f.CSS.ITEM_ORDER).hasClass("openstudio-orderpost-item-canreorder")){var c=a(this).next();c.find(f.CSS.ITEM_ORDER).hasClass(b)?f.disableContentButton():f.showErrorMessage("")}})},checkReorderLock:function(b,c){var d="",e="",g="openstudio-orderpost-item-canreorder";if(b>c?(d=c,e=b):(d=b,e=c),e-d>1)for(;d<=e;){var h=a(f.CSS.ITEM_ORDER+'[data-order="'+d+'"]');if(h.hasClass(g)&&(d<b||d<c))return!0;d++}return!1},showErrorMessage:function(b){a(".openstudio-message-error").text(b)}}});