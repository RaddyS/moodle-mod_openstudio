define(["jquery","core/ajax","core/str","core/templates","require"],function(a,b,c,d,e){var f;return f={mconfig:null,CSS:{ORDER_POSTS_BUTTON:"#id_orderpost",MOVE_UP_BUTTON:".openstudio-orderpost-item-moveup-button",MOVE_DOWN_BUTTON:".openstudio-orderpost-item-movedown-button",SAVE_ORDER_BUTTON:".openstudio-orderpost-save-button",ORDER_NUMBER_INPUT:".openstudio-orderpost-item-order-number-input",ITEM_CONTAINER:".openstudio-orderpost-item",ITEM_ORDER:".openstudio-orderpost-item-order",ORDER_POSTS_DIALOGUE_CONTAINER:".openstudio-orderposts-dialogue"},init:function(b){f.mconfig=b,Y.use("moodle-core-notification-dialogue",function(){e(["mod_openstudio/osdialogue"],function(a){f.dialogue=f.createOrderPostsDialogue(a)})}),a(f.CSS.ORDER_POSTS_BUTTON).on("click",function(){if(f.dialogue){a(".openstudio-folder-posts-dialogue .openstudio-orderpost").remove(),f.setBody(f.dialogue),f.dialogue.show();var b=f.getListOrderPost(),c=[];a.each(b,function(a,b){c[a]=b[0]}),f.mconfig.listorder=c.join(","),setTimeout(function(){f.resize()},200)}}),a("body").delegate(f.CSS.SAVE_ORDER_BUTTON,"click",f.saveOrder).delegate(f.CSS.MOVE_UP_BUTTON,"click",f.moveUp).delegate(f.CSS.MOVE_DOWN_BUTTON,"click",f.moveDown).delegate(f.CSS.ORDER_NUMBER_INPUT,"keyup",f.handleNumberInputEnter).delegate(f.CSS.ORDER_NUMBER_INPUT,"blur",f.handleNumberInputBlur),a(window).resize(f.resize.bind(f))},createOrderPostsDialogue:function(a){function b(){c.get_string("folderorderpost","mod_openstudio").done(function(a){d.set("headerContent","<span>"+a+"</span>")})}var d=new a({closeButton:!0,visible:!1,centered:!0,modal:!0,responsive:!0,width:640,responsiveWidth:767,focusOnPreviousTargetAfterHide:!0,extraClasses:[f.CSS.ORDER_POSTS_DIALOGUE_CONTAINER.replace(".",""),"openstudio-folder-posts-dialogue"]});return b(),f.setBody(d),d},setBody:function(c){M.util.js_pending("openstudioGetOrderPostsFolderContent");var d=b.call([{methodname:"mod_openstudio_external_get_order_posts",args:{cmid:f.mconfig.cmid,folderid:f.mconfig.folderid}}]);d[0].done(function(b){c.set("bodyContent",b.html),f.disableFirstLastButton(),a(document).ready(f.disableContentButton),f.checkReorder(),f.inputPosition(),a(f.CSS.SAVE_ORDER_BUTTON).attr("disabled","disabled"),f.resize()}).always(function(){M.util.js_complete("openstudioGetOrderPostsFolderContent")}).fail(function(a){window.console.error("Log request failed "+a.message)})},moveUp:function(){var b=a(this).closest(f.CSS.ITEM_CONTAINER),c=b.find(f.CSS.ITEM_ORDER).attr("data-order");c=parseInt(c),f.swapItems(c,c-1,b)},moveDown:function(){var b=a(this).closest(f.CSS.ITEM_CONTAINER),c=b.find(f.CSS.ITEM_ORDER).attr("data-order");c=parseInt(c),f.swapItems(c,c+1,b)},moveTo:function(){var b=a(this).val();if(!(b<=0||b>f.mconfig.total)){var d=a(this).closest(f.CSS.ITEM_CONTAINER),e=d.find(f.CSS.ITEM_ORDER).attr("data-order");e=parseInt(e);var g=a(f.CSS.ITEM_CONTAINER).last().find(f.CSS.ITEM_ORDER).attr("data-order");g=parseInt(g);var h=a("div[data-order="+e+"]").hasClass("openstudio-orderpost-item-canreorder"),i=a("div[data-order="+b+"]").hasClass("openstudio-orderpost-item-canreorder");if(h&&i)return void c.get_string("foldercontentcannotreorder","mod_openstudio").done(function(a){f.showErrorMessage(a)});b>g&&(b=g),b<1&&(b=1),f.swapItems(e,b,d)}},saveOrder:function(){a(f.CSS.ORDER_NUMBER_INPUT).each(function(){var b=a(this).val().trim(),c=a(this).closest(f.CSS.ITEM_CONTAINER),d=c.find(f.CSS.ITEM_ORDER).attr("data-order");d=parseInt(d),b!=d&&f.swapItems(d,b,c)}),M.util.js_pending("openstudioOrderPostsFolderContent");var c=f.getListOrderPost(!0),d={},e="",g="";a.each(c,function(a,b){g=b[0],e=b[1],g!=e&&(d[e-1]=g)}),c="",a.each(d,function(a,b){c+=a+"-"+b+","}),c=c.substr(0,c.length-1);var h=b.call([{methodname:"mod_openstudio_external_order_posts",args:{cmid:f.mconfig.cmid,folderid:f.mconfig.folderid,listorderporst:c}}]);h[0].done(function(){window.location.reload()}).always(function(){M.util.js_complete("openstudioOrderPostsFolderContent")}).fail(function(a){window.console.error("Log request failed "+a.message)})},swapItems:function(b,d,e){var g=!1,h=a(f.CSS.ITEM_ORDER+'[data-order="'+d+'"]');if(e.find(f.CSS.ITEM_ORDER).hasClass("openstudio-orderpost-item-canreorder")&&(g=f.checkReorderLock(b,d)),1==g)return void c.get_string("foldercontentcannotreorder","mod_openstudio").done(function(a){f.showErrorMessage(a)});h.length>0&&(b<d?h.closest(f.CSS.ITEM_CONTAINER).after(e):h.closest(f.CSS.ITEM_CONTAINER).before(e),a(f.CSS.ITEM_CONTAINER).each(function(b){b+=1;var c=b<10?"0"+b:""+b;a(this).find(f.CSS.ITEM_ORDER).attr("data-order",b).text(c),a(this).find(f.CSS.ORDER_NUMBER_INPUT).val(b);var d=a(this).find(f.CSS.MOVE_UP_BUTTON).attr("title"),e=d.match(/([0-9-.]+)/g);if(null!==e){var g=e.length,h=e[g-1],i=d.replace(h,b-1+".");a(this).find(f.CSS.MOVE_UP_BUTTON).attr("title",i)}var j=a(this).find(f.CSS.MOVE_DOWN_BUTTON).attr("title"),k=j.match(/([0-9-.]+)/g);if(null!==k){var l=k.length,m=k[l-1],n=j.replace(m,b+1+".");a(this).find(f.CSS.MOVE_DOWN_BUTTON).attr("title",n)}}));var i=f.mconfig.listorder,j=f.getListOrderPost(),k=[];a.each(j,function(a,b){k[a]=b[0]});var l=k.join(",");f.enableSaveOrder(i,l),f.checkReorder(),f.disableContentButton(),f.disableFirstLastButton()},resize:function(){f.dialogue&&f.dialogue.get("visible")&&(Y.one("body").get("winWidth")<f.dialogue.get("responsiveWidth")?(f.dialogue.makeResponsive(),a(f.CSS.SAVE_ORDER_BUTTON).removeClass("osep-smallbutton")):(a(f.CSS.SAVE_ORDER_BUTTON).addClass("osep-smallbutton"),Y.one("body").get("winWidth")>=767?f.dialogue.set("width",640):f.dialogue.set("width",500),f.dialogue.centerDialogue()))},getListOrderPost:function(b){var c={};a(f.CSS.ITEM_CONTAINER).each(function(){var d=a(this).find(f.CSS.ITEM_ORDER);b&&d.hasClass("openstudio-orderpost-item-book")||(c[d.attr("data-order")]=d.attr("data-original-order"))});var d=[];for(var e in c)d.push([e,c[e]]);return d.sort(function(a,b){return a[1]-b[1]}),d},enableSaveOrder:function(b,c){b!=c?a(f.CSS.SAVE_ORDER_BUTTON).removeAttr("disabled"):a(f.CSS.SAVE_ORDER_BUTTON).attr("disabled","disabled")},inputPosition:function(){a(document).ready(function(){a(f.CSS.ORDER_NUMBER_INPUT).keyup(function(){f.enableSaveOrder(a(this).val().length,0);var b=a(this).val();b&&!a.isNumeric(b)?c.get_string("errormoveslotnumeric","mod_openstudio").done(function(a){f.showErrorMessage(a)}):parseInt(b)>f.mconfig.total||parseInt(b)<=0?c.get_string("errormoveslotoutofrange","mod_openstudio").done(function(a){f.showErrorMessage(a)}):f.showErrorMessage(""),a(this).val(b)})})},disableFirstLastButton:function(){a(f.CSS.MOVE_UP_BUTTON+":not(.openstudio-orderpost-item-book)").removeAttr("disabled"),a(f.CSS.MOVE_DOWN_BUTTON+":not(.openstudio-orderpost-item-book)").removeAttr("disabled"),a(f.CSS.MOVE_UP_BUTTON+":first").attr("disabled","disabled"),a(f.CSS.MOVE_DOWN_BUTTON+":last").attr("disabled","disabled")},disableContentButton:function(){a(".openstudio-orderpost-item-book").attr("disabled","disabled")},checkReorder:function(){a(f.CSS.ITEM_CONTAINER).each(function(){var b="openstudio-orderpost-item-canreorder";if(a(this).find(f.CSS.ITEM_ORDER).hasClass("openstudio-orderpost-item-canreorder")){var c=a(this).next();c.find(f.CSS.ITEM_ORDER).hasClass(b)?f.disableContentButton():f.showErrorMessage("")}})},checkReorderLock:function(b,c){var d="",e="",g="",h="openstudio-orderpost-item-canreorder";if(b>c?(d=c,e=b):(d=b,e=c),b<c)for(d+=1;d<=e;){if(g=a(f.CSS.ITEM_ORDER+'[data-order="'+d+'"]'),g.hasClass(h))return!0;d++}else for(e-=1;e>=d;){if(g=a(f.CSS.ITEM_ORDER+'[data-order="'+e+'"]'),g.hasClass(h))return!0;e--}return!1},showErrorMessage:function(b){a(".openstudio-message-error").text(b)},handleNumberInputEnter:function(a){13===a.which&&f.moveTo.call(this)},handleNumberInputBlur:function(){f.moveTo.call(this)}}});