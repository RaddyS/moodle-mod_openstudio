define(["jquery","core/ajax","core/str","require"],function(a,b,c,d){var e;return e={mconfig:null,CSS:{ADD_NEW_BUTTON:"#id_addcomment",REPLY_BUTTON:'input[name="replycommentbutton"]',LIKE_BUTTON:".openstudio-comment-flag-link",DELETE_BUTTON:".openstudio-comment-delete-link",DELETE_CONFIRM_BUTTON:".openstudio-comment-delete-btn",COMMENT_FORM_CONTENT:".openstudio-comment-form-content",COMMENT_FORM:".openstudio-comment-form",COMMENT_REPLY_FORM:".openstudio-comment-reply-form",COMMENT_ATTACHMENT:".openstudio-comment-form-content .filepicker-filename > a",COMMENT_THREAD:".openstudio-comment-thread",COMMENT_THREAD_BODY:".openstudio-comment-thread-body",REPLY_THREAD:".openstudio-comment-thread-replied-items",COMMENT_ITEM:".openstudio-comment-thread-item",FLAG_COUNT:".openstudio-comment-flag-count",FLAG_STATUS:".openstudio-comment-flag-status",DIALOG_HEADER:".openstudio-comment-delete-header",BOUNDING_BOX:".openstudio-comment-dialogue-container"},init:function(b){e.mconfig=b,Y.use("moodle-core-notification-dialogue",function(){d(["mod_openstudio/osdialogue"],function(a){e.dialogue=e.createDeleteCommentDialogue(a)})}),a(e.CSS.ADD_NEW_BUTTON).on("click",e.showCommentForm.bind(e)),a("body").delegate(e.CSS.REPLY_BUTTON,"click",e.showReplyForm).delegate(e.CSS.LIKE_BUTTON,"click",e.likeComment).delegate(e.CSS.DELETE_BUTTON,"click",e.deleteConfirm).delegate(e.CSS.DELETE_CONFIRM_BUTTON,"click",e.deleteComment),a(e.CSS.COMMENT_FORM).find("form").on("submit",e.postComment),a(window).resize(e.resize)},showCommentForm:function(){a(e.CSS.COMMENT_FORM_CONTENT).appendTo(e.CSS.COMMENT_FORM),a(e.CSS.COMMENT_FORM_CONTENT).show(),e.resetForm(),a(e.CSS.ADD_NEW_BUTTON).hide(),a(e.CSS.COMMENT_REPLY_FORM).hide(),e.scrollToEl(a(e.CSS.COMMENT_FORM_CONTENT))},showReplyForm:function(){var b=a(this).data("comment-parent").trim(),c=a(e.CSS.COMMENT_THREAD).filter(function(){return a(this).data("thread-items")==b}).find(e.CSS.COMMENT_REPLY_FORM);a(e.CSS.COMMENT_FORM_CONTENT).appendTo(c),c.show(),a(e.CSS.COMMENT_FORM_CONTENT).show(),e.resetForm(),a(e.CSS.ADD_NEW_BUTTON).show(),a(e.CSS.COMMENT_FORM_CONTENT).find('form input[name="inreplyto"]').val(parseInt(b)),e.scrollToEl(c)},resetForm:function(){a(e.CSS.COMMENT_FORM_CONTENT).find(".editor_atto_content").html(""),a(e.CSS.COMMENT_FORM_CONTENT).find('form input[name="inreplyto"]').val(0),a(e.CSS.COMMENT_ATTACHMENT).remove()},postComment:function(c){c.preventDefault(),c.stopImmediatePropagation();var d={};a.each(a(this).serializeArray(),function(a,b){d[b.name]=b.value});var f=a(e.CSS.COMMENT_ATTACHMENT).length>0;M.util.js_pending("openstudioPostComment");var g=b.call([{methodname:"mod_openstudio_external_add_comment",args:{cmid:d.cmid,cid:d.cid,folderid:d.folderid,inreplyto:parseInt(d.inreplyto.trim()),commenttext:d["commentext[text]"],commentattachment:f?d.commentattachment:0}}]);g[0].done(function(b){a(e.CSS.ADD_NEW_BUTTON).show(),a(e.CSS.COMMENT_FORM_CONTENT).hide(),a(e.CSS.COMMENT_REPLY_FORM).hide();var c=parseInt(d.inreplyto.trim());c?(a(e.CSS.COMMENT_THREAD).filter(function(){return a(this).data("thread-items")==c}).find(e.CSS.REPLY_THREAD).find(e.CSS.COMMENT_ITEM).last().before(b.commenthtml),e.scrollToEl(a('[data-thread-item="'+b.commentid+'"]'))):(a(e.CSS.COMMENT_THREAD_BODY).append(b.commenthtml),e.scrollToEl(a('[data-thread-items="'+b.commentid+'"]'))),a(e.CSS.COMMENT_THREAD).show(),window.oump&&window.oump.harvest()}).always(function(){M.util.js_complete("openstudioPostComment")}).fail(function(a){window.console.error("Log request failed "+a.message)})},likeComment:function(c){c.preventDefault();var d=a(this);M.util.js_pending("openstudioLikeComment");var f=b.call([{methodname:"mod_openstudio_external_flag_comment",args:{cmid:e.mconfig.cmid,cid:e.mconfig.cid,commentid:d.data("comment-id")}}]);f[0].done(function(a){d.hide().siblings(e.CSS.FLAG_COUNT).addClass("flagged").text(a.count).siblings(e.CSS.FLAG_STATUS+".flagged").removeClass("openstudio-hidden").siblings(e.CSS.FLAG_STATUS+".unflagged").addClass("openstudio-hidden")}).always(function(){M.util.js_complete("openstudioLikeComment")}).fail(function(a){window.console.error("Log request failed "+a.message)})},deleteComment:function(){var c=parseInt(a(this).attr("data-comment-id"));M.util.js_pending("openstudioDeleteComment");var d=b.call([{methodname:"mod_openstudio_external_delete_comment",args:{cmid:e.mconfig.cmid,commentid:c}}]);d[0].done(function(){a(e.CSS.COMMENT_FORM_CONTENT).appendTo(e.CSS.COMMENT_FORM);var b=a('[data-thread-items="'+c+'"]'),d=a('[data-thread-item="'+c+'"]');b.length>0?b.remove():d.remove(),0==a("div[data-thread-items]").length&&a(e.CSS.COMMENT_THREAD).hide(),e.dialogue.hide()}).always(function(){M.util.js_complete("openstudioDeleteComment")}).fail(function(a){window.console.error("Log request failed "+a.message)})},createDeleteCommentDialogue:function(a){var b=new a({closeButton:!0,visible:!1,centered:!0,responsive:!0,responsiveWidth:767,modal:!0,focusOnPreviousTargetAfterHide:!0,width:521,extraClasses:[e.CSS.BOUNDING_BOX.replace(".","")]}),d={name:"cancel",classNames:"openstudio-cancel-btn",action:"hide"},f={name:"delete",classNames:e.CSS.DELETE_CONFIRM_BUTTON.replace(".","")};return c.get_strings([{key:"contentcommentsdelete",component:"mod_openstudio"},{key:"modulejsdialogcommentdeleteconfirm",component:"mod_openstudio"},{key:"modulejsdialogcancel",component:"mod_openstudio"},{key:"modulejsdialogdelete",component:"mod_openstudio"}]).done(function(a){d.label=a[2],f.label=a[3],b.set("headerContent",'<span class="openstudio-dialogue-common-header '+e.CSS.DIALOG_HEADER.replace(".","")+'">'+a[0]+"</span>"),b.set("bodyContent",a[1]),b.addButton(f,["footer"]),b.addButton(d,["footer"])}),b},deleteConfirm:function(b){b.preventDefault(),e.dialogue&&(a(e.CSS.DELETE_CONFIRM_BUTTON).attr("data-comment-id",a(this).data("comment-id")),e.dialogue.show())},resize:function(){e.dialogue&&e.dialogue.get("visible")&&(Y.one("body").get("winWidth")<=e.dialogue.get("responsiveWidth")?e.dialogue.makeResponsive():e.dialogue.centerDialogue())},scrollToEl:function(b){setTimeout(function(){a("html, body").animate({scrollTop:b.offset().top-100},1500)},100)}}});