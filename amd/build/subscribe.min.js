define(["jquery","core/yui","core/templates","core/str","core/ajax","require"],function(a,b,c,d,e,f){var g;return g={dialogue:null,mconfig:null,CSS:{SUBSCRIBESETTING:".openstudio-subscribe-button",BOUNDINGBOX:".openstudio-subscribe-dialog-container",DIALOGHEADER:".openstudio-subscription-header",SUBSCRIBEBUTTON:'button[name="subscribebutton"]'},init:function(c){g.mconfig=c,b.use("moodle-core-notification-dialogue",function(){f(["mod_openstudio/osdialogue"],function(a){g.dialogue=g.createSubscriptionDialogue(a,g.CSS.BOUNDINGBOX)})}),a(g.CSS.SUBSCRIBEBUTTON).on("click",function(){g.issubscribed()?g.unsubscribe():(g.dialogue.show(),g.resize())}),a(window).resize(g.resize.bind(g))},createSubscriptionDialogue:function(a,b){function e(){d.get_string("subscriptiondialogheader","mod_openstudio").done(function(a){i.set("headerContent",'<span class="'+g.CSS.DIALOGHEADER.replace(".","")+'">'+a+"</span>")})}function f(){c.render("mod_openstudio/subscribe_dialog",g.mconfig.constants).done(function(a){i.set("bodyContent",a)})}function h(){d.get_strings([{key:"subscriptiondialogcancel",component:"mod_openstudio"},{key:"subscribe",component:"mod_openstudio"}]).done(function(a){var b={name:"cancel",label:a[0],classNames:"openstudio-cancel-btn",action:"hide"};i.addButton(b,["footer"]);var c={name:"subscribe",label:a[1],classNames:"openstudio-subscript-btn",events:{click:g.subscribe.bind(g)}};i.addButton(c,["footer"])})}var i=new a({closeButton:!0,visible:!1,centered:!1,responsive:!0,focusOnPreviousTargetAfterHide:!0,extraClasses:[b.replace(".","")]});return e(),f(),h(),i},subscribe:function(){function b(){var b={openstudioid:g.mconfig.openstudioid,emailformat:a('select[name="openstudio-subscription-email-format"]').val(),frequency:a('select[name="openstudio-subscription-email-frequency"]').val(),userid:g.mconfig.userid};M.util.js_pending("openstudioSubscribe");var d=e.call([{methodname:"mod_openstudio_external_subscribe",args:b}]);d[0].done(function(a){c(a.subscriptionid)}).always(function(){M.util.js_complete("openstudioSubscribe")}).fail(function(a){window.console.error("Log request failed "+a.message)})}function c(b){d.get_string("unsubscribe","mod_openstudio").done(function(b){a(g.CSS.SUBSCRIBEBUTTON).text(b)}),a(g.CSS.SUBSCRIBEBUTTON).attr("subscriptionid",b)}g.dialogue.hide(),b()},unsubscribe:function(){function b(){var b={subscriptionid:a(g.CSS.SUBSCRIBEBUTTON).attr("subscriptionid"),userid:g.mconfig.userid,cmid:g.mconfig.cmid};M.util.js_pending("openstudioUnsubscribe");var d=e.call([{methodname:"mod_openstudio_external_unsubscribe",args:b}]);d[0].done(function(){c()}).always(function(){M.util.js_complete("openstudioUnsubscribe")}).fail(function(a){window.console.warn("Log request failed "+a.message)})}function c(){d.get_string("subscribetothisstudio","mod_openstudio").done(function(b){a(g.CSS.SUBSCRIBEBUTTON).text(b)}),a(g.CSS.SUBSCRIBEBUTTON).removeAttr("subscriptionid")}b()},issubscribed:function(){return a(g.CSS.SUBSCRIBEBUTTON)[0].hasAttribute("subscriptionid")},resize:function(){var c=g.dialogue.get("visible");if(b.one("body").get("winWidth")>767){if(g.dialogue.get("boundingBox").setStyles({top:3,right:211,left:"auto",width:316}),"large"==g.sizing)return;g.dialogue.hide(),g.sizing="large",a(g.CSS.SUBSCRIBESETTING).after(a(g.CSS.BOUNDINGBOX).parent()),c&&g.dialogue.show(),g.dialogue.get("boundingBox").setStyles({top:3,right:211,left:"auto",width:316})}else{if("small"==g.sizing)return;g.sizing="small",g.dialogue.hide(),c&&g.dialogue.show(),a(g.CSS.BOUNDINGBOX).parent().appendTo(a("body"))}}}});