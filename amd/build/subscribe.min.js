define(["jquery","core/yui","core/templates","core/str"],function(a,b,c,d){var e;return e={dialogue:null,mconfig:null,CSS:{SUBSCRIBESETTING:".openstudio-subscribe-button",BOUNDINGBOX:".openstudio-subscribe-dialog-container",DIALOGHEADER:".openstudio-subscription-header",SUBSCRIBEBUTTON:'button[name="subscribebutton"]'},init:function(b){e.mconfig=b,e.dialogue=e.createSubscriptionDialogue(e.CSS.BOUNDINGBOX),a(e.CSS.SUBSCRIBEBUTTON).on("click",function(){e.issubscribed()?e.unsubscribe():(e.dialogue.show(),e.resize())}),a(window).resize(e.resize.bind(e))},createSubscriptionDialogue:function(a){function b(){var a="Subscription settings";d.get_string("subscriptiondialogheader","mod_openstudio").done(function(b){a=b}).always(function(){h.set("headerContent",'<span class="'+e.CSS.DIALOGHEADER.replace(".","")+'">'+a+"</span>")})}function f(){c.render("mod_openstudio/subscribe_dialog",e.mconfig.constants).done(function(a){h.set("bodyContent",a)})}function g(){var a={name:"cancel",label:"Cancel",classNames:"openstudio-cancel-btn",action:"hide"};d.get_string("subscriptiondialogcancel","mod_openstudio").done(function(b){a.label=b}).always(function(){h.addButton(a,["footer"])});var b={name:"subscribe",label:"Subscribe",classNames:"openstudio-subscript-btn",events:{click:e.subscribe.bind(e)}};d.get_string("subscribe","mod_openstudio").done(function(a){b.label=a}).always(function(){h.addButton(b,["footer"])})}var h=new M.core.dialogue({closeButton:!0,visible:!1,centered:!1,responsive:!0,focusOnPreviousTargetAfterHide:!0,extraClasses:[a.replace(".","")]});return b(),f(),g(),h},subscribe:function(){function b(){require(["core/ajax"],function(b){var d={openstudioid:e.mconfig.openstudioid,emailformat:a('select[name="openstudio-subscription-email-format"]').val(),frequency:a('select[name="openstudio-subscription-email-frequency"]').val(),userid:e.mconfig.userid},f=b.call([{methodname:"mod_openstudio_external_subscribe",args:d}]);f[0].done(function(a){a.success&&c(a.subscriptionid)}).fail(function(a){window.console.error("Log request failed "+a.message)})})}function c(b){var c="Unsubscribe";d.get_string("unsubscribe","mod_openstudio").done(function(a){c=a}).always(function(){a(e.CSS.SUBSCRIBEBUTTON).text(c)}),a(e.CSS.SUBSCRIBEBUTTON).attr("subscriptionid",b)}e.dialogue.hide(),b()},unsubscribe:function(){function b(){require(["core/ajax"],function(b){var d={subscriptionid:a(e.CSS.SUBSCRIBEBUTTON).attr("subscriptionid"),userid:e.mconfig.userid,cmid:e.mconfig.cmid},f=b.call([{methodname:"mod_openstudio_external_unsubscribe",args:d}]);f[0].done(function(a){a.success&&c()}).fail(function(a){window.console.warn("Log request failed "+a.message)})})}function c(){var b="Subscribe to my studio";d.get_string("subscribetothisstudio","mod_openstudio").done(function(a){b=a}).always(function(){a(e.CSS.SUBSCRIBEBUTTON).text(b)}),a(e.CSS.SUBSCRIBEBUTTON).removeAttr("subscriptionid")}b()},issubscribed:function(){return a(e.CSS.SUBSCRIBEBUTTON)[0].hasAttribute("subscriptionid")},resize:function(){var c=e.dialogue.get("visible");if(b.one("body").get("winWidth")>767){if(e.dialogue.get("boundingBox").setStyles({top:3,right:200,left:"auto",width:316}),"large"==e.sizing)return;e.dialogue.hide(),e.sizing="large",a(e.CSS.SUBSCRIBESETTING).after(a(e.CSS.BOUNDINGBOX).parent()),c&&e.dialogue.show(),e.dialogue.get("boundingBox").setStyles({top:3,right:200,left:"auto",width:316})}else{if("small"==e.sizing)return;e.sizing="small",e.dialogue.hide(),c&&e.dialogue.show(),a("body").after(a(e.CSS.BOUNDINGBOX).parent())}}}});